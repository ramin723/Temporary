# مستندات سیستم QR

## بررسی کلی

سیستم QR در این پلتفرم از دو نوع QR مختلف استفاده می‌کند:

1. **QR مکانیک (کاغذی)** - برای شناسایی مکانیک در فروشگاه‌ها
2. **QR سفارش (آنلاین)** - برای اشتراک‌گذاری سفارش‌ها با مشتریان

## تفاوت‌های کلیدی

### QR مکانیک (کاغذی)
- **محتوا**: `MECH:<code>` (مثال: `MECH:ABC123`)
- **کاربرد**: شناسایی مکانیک در POS فروشگاه
- **فرمت**: متن ساده، بدون URL
- **مدیریت**: توسط ادمین (فعال/غیرفعال، بازتولید)
- **امنیت**: کد یکتا، قابل باطل‌سازی

### QR سفارش (آنلاین)
- **محتوا**: لینک کامل `/o/<orderCode>`
- **کاربرد**: اشتراک‌گذاری با مشتری، مشاهده جزئیات
- **فرمت**: URL کامل
- **مدیریت**: توسط مکانیک (ایجاد، مشاهده)
- **امنیت**: یکبار مصرف، قابل ردیابی

## مسیرهای API

### مدیریت QR مکانیک (فقط ADMIN)

#### دریافت لیست مکانیک‌ها
```
GET /api/admin/mechanics
Query Parameters:
- search: جستجو در نام یا کد
- qrStatus: وضعیت QR (true/false)
- page: شماره صفحه
- pageSize: اندازه صفحه

Response:
{
  "ok": true,
  "items": [
    {
      "id": 1,
      "code": "ABC123",
      "city": "تهران",
      "status": "ACTIVE",
      "qrActive": true,
      "createdAt": "2024-01-01T00:00:00Z",
      "user": {
        "fullName": "علی احمدی",
        "phone": "0912***0000"
      }
    }
  ],
  "totalCount": 10,
  "page": 1,
  "pageSize": 20
}
```

#### دریافت جزئیات مکانیک
```
GET /api/admin/mechanics/{id}

Response:
{
  "ok": true,
  "mechanic": {
    "id": 1,
    "code": "ABC123",
    "city": "تهران",
    "status": "ACTIVE",
    "qrActive": true,
    "createdAt": "2024-01-01T00:00:00Z",
    "fullName": "علی احمدی",
    "phoneMasked": "0912***0000",
    "stats": {
      "totalTransactions": 25
    }
  }
}
```

#### تغییر وضعیت QR
```
POST /api/admin/mechanics/{id}/qr/toggle
Body: { "active": boolean }

Response:
{
  "ok": true,
  "mechanic": {
    "id": 1,
    "code": "ABC123",
    "qrActive": true
  },
  "message": "QR فعال شد"
}
```

#### بازتولید کد QR
```
POST /api/admin/mechanics/{id}/qr/regenerate

Response:
{
  "ok": true,
  "mechanic": {
    "id": 1,
    "code": "XYZ789",
    "qrActive": true
  },
  "message": "کد QR با موفقیت بازتولید شد و فعال شد",
  "warning": "کد قبلی باطل شده است"
}
```

## اسکن QR در POS

### الگوریتم تشخیص نوع QR

```typescript
function parseScanned(str: string) {
  const s = (str || '').trim()
  
  // 1. بررسی پیشوندهای صریح
  if (s.startsWith('ORDER:')) {
    return { kind: 'order', code: s.slice(6) }
  }
  if (s.startsWith('MECH:')) {
    return { kind: 'mechanic', code: s.slice(5) }
  }
  
  // 2. تشخیص بر اساس الگو
  if (s.length >= 8) {
    return { kind: 'order', code: s }
  } else if (s.length >= 3 && s.length <= 8) {
    return { kind: 'mechanic', code: s }
  }
  
  // 3. پیش‌فرض
  return { kind: 'mechanic', code: s }
}
```

### سناریوهای اسکن

#### اسکن QR مکانیک
1. **ورودی**: `MECH:ABC123` یا `ABC123`
2. **پردازش**: اعتبارسنجی کد مکانیک
3. **نتیجه**: پر کردن اطلاعات مکانیک در فرم POS
4. **خطاها**: 404 (مکانیک یافت نشد)، 403 (دسترسی محدود)

#### اسکن QR سفارش
1. **ورودی**: `ORDER:XYZ789` یا `XYZ789`
2. **پردازش**: دریافت اطلاعات سفارش
3. **نتیجه**: پر کردن خودکار فرم POS
4. **خطاها**: 404 (سفارش یافت نشد)، 409 (قبلاً مصرف شده)

## صفحات مدیریت

### هاب ادمین (`/admin`)
- کارت "مکانیک‌ها (QR/مدیریت)" → `/admin/mechanics`
- کارت "تسویه‌ها" → `/admin/settlements`

### لیست مکانیک‌ها (`/admin/mechanics`)
- نمایش تمام مکانیک‌ها با وضعیت QR
- فیلتر بر اساس وضعیت QR
- جستجو در نام و کد
- لینک به صفحه مدیریت هر مکانیک

### مدیریت QR مکانیک (`/admin/mechanics/{id}`)
- نمایش اطلاعات پایه مکانیک
- نمایش QR Code (محتوای `MECH:<code>`)
- دانلود PNG/SVG
- پرینت QR
- فعال/غیرفعال کردن QR
- بازتولید کد (با تأیید)

## هاب مکانیک

### صفحه اصلی (`/mechanic`)
- 4 کارت اصلی:
  1. **تراکنش‌ها** → `/mechanic/transactions`
  2. **تسویه‌ها** → `/mechanic/settlements`
  3. **سفارش جدید** → `/mechanic/orders/new`
  4. **سفارش‌های من** → `/mechanic/orders`

### لینک‌های بازگشت
تمام صفحات مکانیک دارای دکمه "بازگشت به هاب" هستند.

## تست‌های امنیت

### Rate Limiting
- **مکانیک‌ها**: 60 درخواست در 5 دقیقه
- **جزئیات مکانیک**: 100 درخواست در 5 دقیقه
- **Toggle QR**: 20 درخواست در 5 دقیقه
- **بازتولید کد**: 5 درخواست در ساعت (سخت‌گیرانه)

### احراز هویت
- تمام API های مدیریت QR: `requireAuth(event, ['ADMIN'])`
- CSRF header برای تمام POST requests
- لاگ تمام عملیات حساس

### لاگ‌های امنیتی
- هیچ PII در لاگ‌ها
- ماسک کردن شماره تلفن
- ردیابی IP و User Agent برای عملیات حساس

## سناریوهای رایج

### 1. مکانیک جدید
1. ادمین مکانیک را در سیستم ثبت می‌کند
2. کد QR خودکار تولید می‌شود
3. QR چاپ و به مکانیک تحویل داده می‌شود
4. مکانیک QR را در فروشگاه‌ها استفاده می‌کند

### 2. بازتولید QR
1. ادمین درخواست بازتولید می‌دهد
2. کد جدید تولید می‌شود
3. کد قبلی باطل می‌شود
4. QR جدید چاپ و توزیع می‌شود

### 3. اسکن در POS
1. فروشنده QR مکانیک را اسکن می‌کند
2. سیستم نوع QR را تشخیص می‌دهد
3. اطلاعات مکانیک پر می‌شود
4. تراکنش ثبت می‌شود

### 4. اسکن سفارش
1. فروشنده QR سفارش را اسکن می‌کند
2. اطلاعات سفارش دریافت می‌شود
3. فرم POS پر می‌شود
4. سفارش مصرف می‌شود

## نکات مهم

### امنیت
- کدهای QR قابل حدس نیستند
- هر بازتولید کد قبلی را باطل می‌کند
- لاگ تمام عملیات حساس
- Rate limiting برای جلوگیری از سوء استفاده

### عملکرد
- استفاده از `useFetch` با کلید پایدار
- بدون `watchEffect` یا لوپ‌های بی‌نهایت
- Pagination برای لیست‌های بزرگ
- Debounced search برای جستجو

### سازگاری
- پشتیبانی از موبایل (mobile-first)
- Tailwind CSS برای طراحی
- Nuxt 4 compatibility
- TypeScript support

## عیب‌یابی

### مشکلات رایج

#### QR تولید نمی‌شود
- بررسی نصب `qrcode` package
- بررسی دسترسی‌های DOM
- بررسی console برای خطاها

#### API خطا می‌دهد
- بررسی احراز هویت
- بررسی CSRF token
- بررسی Rate limiting
- بررسی لاگ‌های سرور

#### اسکن کار نمی‌کند
- بررسی دسترسی دوربین
- بررسی فرمت QR
- بررسی منطق تشخیص نوع

### لاگ‌های مفید
```bash
# لاگ‌های ادمین
grep "ADMIN MECHANIC" logs/app.log

# لاگ‌های QR
grep "QR_" logs/app.log

# لاگ‌های امنیتی
grep "SECURITY EVENT" logs/app.log
```
